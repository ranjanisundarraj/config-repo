pipeline {
	agent any
	stages {
		//Properties File Initiation
		stage('Properties File Load') 
			{
				steps {
					script {
						gitProps = readProperties file: 'ConfigRepo/PropertiesFile/pipeline.properties'
						echo "Properties File loaded"
						}
					}
			}

			//GIT Cloning
			stage('Git Clone') 
			{
				steps {
					git url: gitProps.GIT_APP_REPO,
					branch: gitProps.GIT_APP_REPO_BRANCH
					echo 'Git Clone completed'
					}
			}

			//SonarQube Analysis
			stage('SonarQube Analysis') {
				steps {
					dir(gitProps.PROJECT_PATH) {
						sh gitProps.SONAR_SCAN
						echo 'SonarQube Analysis completed'
					}
				}
			}
			
			//Maven Build
			stage('Build Maven') {
				steps {
					dir(gitProps.PROJECT_PATH) {
						sh gitProps.MAVEN_BUILD
						echo 'Maven Build completed'
					}
				}
			}			
			
			//Artifactory Upload
			stage('Artifacts Upload') {
				steps {
					script {
						server = Artifactory.server gitProps.ARTIFACTORY_ID
						def uploadSpec = """{
								"files": [
	                    						{
	                    			"pattern": "target/*.war",
	                        		"target": "example-repo-local/target/Build #${env.BUILD_NUMBER}/"
	                    						}
	                    						]
	                					}"""
	                				server.upload(uploadSpec) 
              						echo "Artifact Uploaded"
	            				}
					}
			}	
			
			//Docker: Creating Volume
			
			 stage('Mount temp volume') {
			 steps{
               				 sh 'docker stop dockertomcat'
               				 sh 'docker rm dockertomcat'
              				 sh 'sudo rm -rf /tmp/webapps'
                			 sh 'mkdir /tmp/webapps'
                			 sh 'cp */target/*.war /tmp/webapps/'  
					 sh docker.image("tomcat:latest").pull();
					 sh 'docker run -d --name dockertomcat -p 8888:8080 -v /tmp/webapps/:/usr/local/tomcat/webapps/:rw tomcat:latest'
				}
     			   }
		}
	
	//Email Trigger
			post {
			always {
				script {
					emailext ( 
						subject: '${DEFAULT_SUBJECT}', 
						body: '${DEFAULT_CONTENT}',
						to: gitProps.TO_RECIPIENT
						)
							echo "Status Mail Sent"
					}
	       			}
			}	

}

